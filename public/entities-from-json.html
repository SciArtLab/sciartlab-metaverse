<!--

 
 "*------------------------------------------------------------------------------*"
 "|                                                                              |"
 "|   ███████╗ ██████╗██╗ █████╗ ██████╗ ████████╗    ██╗      █████╗ ██████╗    |"
 "|   ██╔════╝██╔════╝██║██╔══██╗██╔══██╗╚══██╔══╝    ██║     ██╔══██╗██╔══██╗   |"
 "|   ███████╗██║     ██║███████║██████╔╝   ██║       ██║     ███████║██████╔╝   |"
 "|   ╚════██║██║     ██║██╔══██║██╔══██╗   ██║       ██║     ██╔══██║██╔══██╗   |"
 "|   ███████║╚██████╗██║██║  ██║██║  ██║   ██║       ███████╗██║  ██║██████╔╝   |"
 "|   ╚══════╝ ╚═════╝╚═╝╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝       ╚══════╝╚═╝  ╚═╝╚═════╝    |"
 "|                                                                              |"
 "|                      SciartLab Metaverse Components                          |"
 "|                                                                              |"
 "|                    **********  VR Experiments *******                        |"
 "|                                                                              |"
 "|                     Twitter:  @dgrmunch  | @sciartlab                        |"
 "|                     Website:  http://www.sciartlab.com]                      |"
 "|                                                                              |"
 "*------------------------------------------------------------------------------*"

* Description: 

Loading entities from an external JSON file. It can be used to create menus
or dynamic visualizations based on REST APIs and external sources.
Initially I had this in mind as a way to access the SciArt Lab projects (information, 
pictures, links) directly from the Metaverse. But it will be used for different 
purposes.

-->

<!-- JAVASCRIPT -->
<script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
<script src="https://sciartlab-vr.glitch.me/js/sciart-lab-vr-basic.js"></script>
<script src="https://unpkg.com/aframe-event-set-component@3.0.3/dist/aframe-event-set-component.min.js"></script>


<script>

  //This will be used as a callback function after calling a REST API
  function processJson(json, params){
    
    var obj = JSON.parse(json);
    var menu_name = params[0];
    var x = params[1];
    var y = params[2];
    var z = params[3];
    
    //We select the scene to append the new entities
    var sceneEl = document.querySelector('a-scene');
    
    //We create a reference entity with absolute coordinates
    var refEl = document.createElement('a-entity');
    refEl.setAttribute('position',  {y: y, x: x, z: z});
    refEl.setAttribute('id', menu_name+'_refEl');
    
    //Append the reference entity to the scene
    sceneEl.appendChild(refEl);

    //We will load the research lines of the SciArt Lab create the menu elements    
    for(var i = 0; i< obj.elements.length; i++){
      
      //We create a container for the entity and the associated elements (texts, lights, info, etc...)
      var entityContainerEl = document.createElement('a-entity');
      entityContainerEl.setAttribute('id', menu_name+'_elementContainer_'+i);

      //The position in the 3D space will be relative to the refEl
      entityContainerEl.setAttribute('position',  {y: 0, x: (i * 3) + 5, z: 0});

      //We create one entity for each research line
      var entityEl = document.createElement('a-entity');
      entityEl.setAttribute('id', menu_name+'_element_'+i);

      //These entities will be cubes (boxes)
      entityEl.setAttribute('geometry', {
              primitive: 'box',
              height: 1,
              width: 1
            });

      //The texture of each box will be the image_url specified in the JSON
      //IMPORTANT: Due to the CORS policy use resources URLs with HTTPS
      entityEl.setAttribute('material', {src: obj.elements[i].image_url});

      //The position in the 3D space will be relative to the entityContainer
      entityEl.setAttribute('position',  {y: 0, x: 0, z: 0});

      //In case there is a url we attach the href and the onclick event to open
      //the link when the user is looking to the entity
      if(obj.elements[i].url != '' && obj.elements[i].url != undefined){
        entityEl.setAttribute('href',  obj.elements[i].url);
        entityEl.setAttribute('onclick', "goToPage('"+entityEl.getAttribute('href')+"')");
      }

      //Sphere on top with context information on hover
      var infoEl = document.createElement('a-sphere');
      infoEl.setAttribute('id', menu_name+'_info_'+i);
      infoEl.setAttribute('radius', '0.1');
      infoEl.setAttribute('color', 'yellow');
      infoEl.setAttribute('opacity', '1');
      infoEl.setAttribute('position', {y: 1.5, x: 0, z: 0}); //Relative to the box
      infoEl.setAttribute('event-set__enter','_event: mouseenter; _target: #'+menu_name+'_infoText_'+i+'; visible: true');
      infoEl.setAttribute('event-set__leave','_event: mouseleave; _target: #'+menu_name+'_infoText_'+i+'; visible: false');
         
      //Append the new info element to the entityContainerEl
      entityContainerEl.appendChild(infoEl);
      
      //Context information which will be displayed when the sphere is hovered
      var infoTextEl = document.createElement('a-text');
      infoTextEl.setAttribute('id', menu_name+'_infoText_'+i);
      infoTextEl.setAttribute('value', obj.elements[i].description);
      infoTextEl.setAttribute('align', 'center');
      infoTextEl.setAttribute('color', 'yellow');
      infoTextEl.setAttribute('visible', 'false');
      infoTextEl.setAttribute('position', {y: 2, x: 0, z: 2}); //Relative to the box
         
      //Append the new info element to the entityContainerEl
      entityContainerEl.appendChild(infoTextEl);
      
      //Add a light on the top of the element
      var lightEl = document.createElement('a-light');
      lightEl.setAttribute('id', menu_name+'_light_'+i);
      lightEl.setAttribute('type', 'point');
      lightEl.setAttribute('shadowCameraVisible', 'true');
      lightEl.setAttribute('color', 'purple');
      lightEl.setAttribute('intensity', '0.2');
      lightEl.setAttribute('position', {y: 2, x: 0, z: 0}); //Relative to the box
      
      //Append the new light to the entityContainerEl
      entityContainerEl.appendChild(lightEl);

      //Append the new entity to the container and that one to the reference entity
      entityContainerEl.appendChild(entityEl);
      refEl.appendChild(entityContainerEl);
      
      //In case there is any name, add it on the top of the link.
      if(obj.elements[i].name != '' && obj.elements[i].name != undefined){
        
        var nameEl = document.createElement('a-text');
        
        nameEl.setAttribute('width', '3');
        nameEl.setAttribute('align', 'center');
        nameEl.setAttribute('color', 'white');
        nameEl.setAttribute('value', obj.elements[i].name);
        nameEl.setAttribute('position',  {y: 1, x: 0, z: 0}); //Relative to the box
        entityContainerEl.appendChild(nameEl);
        
        infoEl.setAttribute('event-set__enter','_event: mouseenter; _target: #'+menu_name+'_infoText_'+i+'; visible: true');
        infoEl.setAttribute('event-set__leave','_event: mouseleave; _target: #'+menu_name+'_infoText_'+i+'; visible: false');
      

      }

    }

  }
  
   AFRAME.registerComponent('xm-json-to-menu', {
        schema: {
          name: {type: 'string'},
          url: {type: 'string'},
          x: {type: 'number'},
          y: {type: 'number'},
          z: {type: 'number'}
         
        },
        init: function () {
          
          var params = [this.data.name, this.data.x, this.data.y, this.data.z];
          
          //Load the JSON with the information of the new entities
          httpGet(this.data.url,processJson,params);

        }
      });
  
</script>
<!-- END JAVASCRIPT -->

<!-- A-FRAME SCENE -->
<a-scene>

  <!-- Add assets-->
  <a-assets>
    <a-asset id="floorImg" src="https://cdn.glitch.com/b870d9ec-1139-44f9-b462-223e4a2c74e7%2Ffloor.jpg?1490307896453"></a-asset>
  </a-assets>

  <!-- Add sky to the scene -->
  <a-sky color="black"></a-sky>
  
  <!-- Add lights -->
  <a-light type="ambient" color="white" intensity="1" position="1 10 -3" rotation="0 0 0" scale="1 1 1"></a-light>    
      
  <a-entity xm-json-to-menu="name: researchLines; url: https://raw.githubusercontent.com/SciArtLab/json-data-repo/master/sciartlab/summary.json; x:-9; y:1; z:-5; ">
  <!-- Add floor to the scene -->
  <a-plane material="src:#floorImg" rotation="-90 0 0" height="100" width="100" position="0 0 0" scale="1 1 1"></a-plane>

  <!--Camera controls-->
  <a-camera >
    <!-- Add gaze cursor to control the scene without external controllers  -->
    <a-entity cursor="fuse: true;fuseTimeout: 2000" position="0 0 -1" geometry="primitive: ring; radiusInner: 0.1; radiusOuter: 0.11" material="color: lightgreen; shader: flat">

        <!-- Add gaze cursor to control the scene without external controllers  -->
        <a-animation begin="click" easing="ease-in" attribute="scale" dur="1000" fill="forwards" from="0.1 0.1 0.1" to="1 1 1"></a-animation>
        <a-animation begin="fusing" easing="ease-in" attribute="scale" fill="backwards" from="1 1 1" to="0.1 0.1 0.1" dur="1000"></a-animation>

    </a-entity>
  </a-camera>

</a-scene>
<!-- END A-FRAME SCENE -->